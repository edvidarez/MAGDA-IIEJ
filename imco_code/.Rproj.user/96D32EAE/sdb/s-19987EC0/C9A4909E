{
    "collab_server" : "",
    "contents" : "# Diego Villamil, OPI\n# CDMX, a 16 de diciembre de 2016. \n\n  \n  \naplicar_crecimiento <- function(base, crec, columnas) {\n  # base <- metros_0; crec <- metros_crec; \n  # columnas <- c(\"CVEENT\", \"CVEMET\", \"zona_metro\")\n  # base <- muns_0; crec <- muns_crec; columnas <- c(\"CVEMUN\")\n  \n  datos <- inner_join(base, crec, by=columnas) %>% \n    mutate(acteco = NA) %>% \n    arrange_(.dots = columnas %>% c(\"trimestre\"))\n  \n  calc_crec <- datos %>% \n    filter(!is.na(crec_fit)) %>% \n    group_by_(.dots = columnas) %>% \n    mutate(es_2014 = (trimestre >= \"2014-12-01\") & \n            (lag(trimestre) < \"2014-12-01\"), \n        crec_acum = cumprod(1 + crec_fit),\n        crec_14 = sum(crec_acum[es_2014]) %>% \n            replace(. == 0, 1), \n        acteco = ae_175*crec_acum/crec_14)\n  \n  datos[!is.na(datos$crec_fit), \"acteco\"] <- calc_crec$acteco\n  return (datos)\n}\n\n\ncrecimiento_vector <- function(crecimiento, base, indice) {\n  if (any(crecimiento %>% is.na)) {\n    warning (\"Hay NAs en crecimiento\")\n    crecimiento <- crecimiento %>% replace(is.na(.), 0)\n  }\n  crec_0 <- cumprod(1 + crecimiento)\n  crec_1 <- crec_0/crec_0[indice]*base\n}\n\n\n## Por zonas metropolitanas. \n\nmetros_0 <- read_csv(\"por_zonas_metro.csv\" %>% \n      file.path(\"../data/resultados/acteco\", .)) %>% \n  mutate(CVEMET = CVEMET %>% str_pad(3, \"left\", \"0\"),\n         CVEENT = CVEENT %>% str_pad(2, \"left\", \"0\")) %>%\n  select(CVEMET, CVEENT, zona_metro, ae_175)\n\nmetros_crec <- read_csv(\"selecto_zona_metro_martes.csv\" %>% \n  file.path(\"../data/resultados/crecimiento\", .)) %>% \n  mutate(CVEMET = CVEMET %>% str_pad(3, \"left\", \"0\"),\n         CVEENT = CVEENT %>% str_pad(2, \"left\", \"0\")) %>% \n  filter(!is.na(trimestre))\n\ncols_crec <- c(\"CVEENT\", \"CVEMET\", \"zona_metro\")\n\nmetros_eco <- left_join(metros_0, metros_crec, \n  by = cols_crec) %>% \n  group_by_(.dots = cols_crec) %>% \n  arrange_(.dots = cols_crec %>% c(\"trimestre\")) %>% \n  mutate(acteco = crecimiento_vector(crec_fit, ae_175, \n              trimestre == \"2014-12-01\"))\n\nwrite_csv(metros_eco %>% select(-ae_175), \n  \"../data/resultados/integrado/selecto_zm_edo_martes.csv\")\n\n# Checar VAR_ANUAL y comparar con CRECIMIENTO_ACUMULADO de INEGI. \n# y reportes.  \nmetros_eco_2 <- metros_eco %>%\n  group_by(trimestre, CVEMET, zona_metro) %>% \n  summarize(magda = sum(acteco, na.rm = TRUE)) %>% \n  group_by(CVEMET, zona_metro) %>% arrange(trimestre) %>% \n  mutate(var_trim  = magda/lag(magda) - 1,   \n         var_anual = magda/lag(magda, 4) - 1, \n      anual_acum = (var_anual + lag(var_anual) + \n          lag(var_anual,2) + lag(var_anual,3))/4) %>% \n  arrange(CVEMET, zona_metro)\n\nwrite_csv(metros_eco_2, \n  \"../data/resultados/integrado/selecto_zona_metro_martes.csv\")\n\n\nmetros_formato <- metros_eco_2 %>% ungroup %>% \n  select(trimestre, zona_metro, magda, anual_acum) %>% \n  filter(month(trimestre) == 12) %>% \n  mutate(año = year(trimestre)) %>% select(-trimestre) %>% \n  gather(\"medida\", \"valor\", magda, anual_acum) %>% \n  filter(!is.na(valor)) %>% \n  unite(\"medida_año\", medida, año) %>% \n  spread(medida_año, valor)\n\nwrite_csv(metros_formato, \"../data/resultados/integrado/reportando.csv\")  \n\n\n## Por estado. \n\nedo_0 <- read_csv(\"../data/bie/processed/pibe.csv\") %>% \n  filter(año == \"2014-12-01\") %>% rename(ae_175 = pibe)\n\nedo_crec <- read_csv(\"../data/resultados/crecimiento\" %>% file.path(\n  \"selecto_estado_martes.csv\"))\n\nedo_eco <- aplicar_crecimiento(edo_0, edo_crec, \n    c(\"CVEENT\", \"Estado\"))\n\nwrite_csv(edo_eco, \n  \"../data/resultados/integrado/selecto_estado.csv\")\n\n\ngg_estados <- edo_eco %>% \n    rename(magda = acteco) %>% \n    gather(\"indice\", \"valor\", itaee, magda, factor_key = TRUE) %>% \n    group_by(Estado, indice) %>% \n    mutate(valor_ = valor/mean(valor), \n           trimestre = trimestre + months(2)) %>% \n  ggplot(aes(trimestre, valor_)) +\n    facet_wrap(~ Estado, nrow = 5) +\n    geom_line(aes(color = indice)) + \n    scale_x_date(\"\") + \n    scale_y_continuous(\"\", labels = NULL) +\n    scale_color_brewer(palette = \"Dark2\") + \n    theme(legend.position = c(5/7, 1/7), \n          axis.text.x = element_text(angle=45, hjust=1))\nprint(gg_estados)\n\nggsave(plot = gg_estados, \n  \"../visualization/figures/estados_x11_selecto_v2.eps\", \n  width = 16, height = 9, dpi = 100)\n\n\n### Esta gráfica es para las zonas metros ###\n# Hay que modificarla porque ahorita no jala bien. \n\n\n# agrupa_metros <- metros_eco_2 %>% \n#   group_by(CVEMET, zona_metro) %>% \n#   summarize(prom_crec = mean(acteco)) %>% \n#   ungroup %>% \n#   mutate(grupo = cut(rank(-prom_crec), 6, FALSE)) \n# \n# gg_series_metros <- metros_eco_2 %>% ungroup %>% \n#   left_join(by = c(\"CVEMET\", \"nombre_corto\"), agrupa_metros) %>% \n#   mutate(nombre_corto = factor(nombre_corto, \n#     levels = agrupa_metros$nombre_corto[\n#       order(-agrupa_metros$prom_crec)])) %>%\n#   ggplot(aes(trimestre, ind_crec, color = nombre_corto)) + \n#     facet_wrap(~ grupo, nrow = 3, scales = \"free_y\") + \n#     geom_line() + \n#     geom_text_repel(data = ungroup(crec_metro) %>% \n#         filter(trimestre == min(trimestre)) %>% \n#         left_join(agrupa_metros, by = c(\"CVEMET\", \"nombre_corto\")), \n#       aes(label = nombre_corto), size = 4, segment.color = NA) + \n#     scale_y_continuous(name = \"Índice ($ miles de millones)\", \n#         labels = . %>% divide_by(1e3)) + \n#     scale_color_manual(values = brewer.pal(9, \"Set1\") %>% rep(10)) +\n#     theme(legend.position = \"none\")\n# print(gg_series_metros)\n# \n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1539037954105.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1187382198",
    "id" : "C9A4909E",
    "lastKnownWriteTime" : 1539032711,
    "last_content_update" : 1539032711,
    "path" : "~/programming/pap/otoño/indice-de-actividad-economica/imco_code/4_juntar_niveles_crecimiento.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}