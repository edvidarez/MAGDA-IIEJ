{
    "collab_server" : "",
    "contents" : "# Diego Villamil, OPI\n# CDMX, 2 de enero de 2017\n\nlibrary(broom)\n\nentrena_modelo <- TRUE\n\n\nitaee <- read_csv(\"../data/bie/processed/itaee.csv\") %>% \n  select(trimestre = fecha, CVEENT, Estado, itaee = original)\n\ncnbv <- read_csv(\"../data/cnbv/processed\" %>% file.path(\n  \"x11_selecto_estados_martes.csv\")) %>%\n  select(trimestre, CVEENT, atm_1 = atm_selecto) %>% \n  filter(trimestre > \"2011-03-01\")\n\n\n\ngg_cnbv <- cnbv %>% \n  filter(trimestre < \"2016-12-01\") %>% \n  ggplot(aes(trimestre, atm_1)) + \n  facet_wrap(~CVEENT, scales = \"free_y\") +\n  geom_line()\nprint(gg_cnbv)\n  \n\nformula_crec <- \"itaee_crec ~ CVEENT + CVEENT:atm_1_crec + \" %>% \n  str_c(\"CVEENT:atm_crec_4 - 1\")  \n  # Lag en f칩rmula no respeta a group_by. \n\n\nif (entrena_modelo) {\n  datos_regresion <- inner_join(itaee, cnbv, \n      by = c(\"trimestre\", \"CVEENT\")) %>% \n    group_by(CVEENT) %>% arrange(trimestre) %>% \n    mutate_at(vars(itaee, atm_1), \n      funs(crec = . %>% divide_by(lag(., 1)) %>% subtract(1))) %>%\n    mutate(atm_crec_4 = lag(atm_1_crec, 4), \n      atm_1_anual = atm_1/lag(atm_1, 4) - 1) %>% \n    filter(trimestre < \"2016-01-01\", trimestre > \"2012-12-01\")\n  \n  # Seguimos el modelo \n  \n  modelo_crec <- glm(data = datos_regresion, \n      formula = as.formula(formula_crec), \n      family=gaussian(), na.action = na.omit)\n  tidy_crec_1 <- modelo_crec %>% tidy\n  \n  #modelo_crec_ <- lm(data = datos_regresion, na.action = na.omit, \n   # formula = as.formula(formula_crec))\n  \n  # glance_crec <- glance(modelo_crec_)\n  \n  # write_csv(glance_crec, \n  #   \"../data/resultados/indicadores/resumen_crecimiento.csv\")\n  \n  \n  # tidy_estados <- datos_regresion %>% \n  #   group_by(CVEENT, Estado) %>% \n  #   do(lm(data = ., \n  #         na.action = na.omit, \n  #         formula = as.formula(formula_individual)) %>% \n  #      tidy) %>% \n  #   select(CVEENT, Estado, term, estimate) %>% \n  #   spread(term, estimate)\n  \n  # glance_estados <- datos_regresion %>% \n  #   group_by(CVEENT, Estado) %>% \n  #   do(lm(data = ., \n  #         na.action = na.omit, \n  #         formula = as.formula(formula_individual)) %>% \n  #      glance) %>% \n  #   select(CVEENT, Estado, r.squared)\n  # \n  \n  if (str_detect(formula_crec, \"CVEENT:atm_1_crec\")) {\n    tidy_crec_2 <- tidy_crec_1 %>% \n      select(term, estimate) %>% \n      mutate(term = term %>% {\n        ifelse(str_detect(., \"[0-9]{2}$\"), str_c(., \":uno\"), .)}) %>% \n      separate(term, c(\"estado\", \"termino\"), sep = \":\") %>% \n      spread(termino, estimate) \n  } else {\n    tidy_crec_2 <- NA\n  }\n  \n  write_csv(tidy_crec_2, \n    \"../data/resultados/indicadores/coeficientes_v2.csv\")\n  \n  saveRDS(modelo_crec, \"../models/modelo_crecimiento_nuevo.rds\")\n} else {\n  estados_ <- itaee %>% \n    select(CVEENT, Estado) %>% unique\n  \n  datos_regresion <- cnbv %>% \n    inner_join(estados_, by = \"CVEENT\") %>% \n    group_by(CVEENT) %>% arrange(trimestre) %>% \n    mutate_at(vars(atm_1), \n      funs(atm_1_crec = . %>% {./lag(.) - 1})) %>%\n    mutate(atm_crec_4 = lag(atm_1_crec, 4), \n      atm_1_anual = atm_1/lag(atm_1, 4) - 1) %>% \n    filter(trimestre > \"2011-07-01\")\n  \n  modelo_crec <- readRDS(\"../data/referencias/modelo_crecimiento.rds\")\n}\n  \n\ngg_cnbv <- datos_regresion %>% \n  ggplot(aes(trimestre, atm_1)) + \n  facet_wrap(~Estado, scales = \"free_y\") + \n  geom_line()\nprint(gg_cnbv)\n\n# Guardamos proyecciones\n\n\nestado_fit <- augment(modelo_crec, newdata = datos_regresion) %>% \n  select(one_of(c(\"itaee\", \"itaee_crec\")), \n         trimestre, CVEENT, Estado, crec_fit = .fitted) \n\ngg_estado <- estado_fit %>% \n    gather(\"crecimiento\", \"valor\", itaee_crec, crec_fit) %>% \n  ggplot(aes(trimestre, valor, color = crecimiento)) +\n    facet_wrap(~ Estado, nrow = 5) +\n    geom_line() + \n    ggtitle(formula_crec) +\n    scale_color_brewer(palette = \"Dark2\")\n\nprint(gg_estado)\n\nggsave(plot = gg_estado, \n  \"../visualization/figures/modelo_x11_selecto_v2.eps\", \n  width = 16, height = 9, dpi = 100)\n\n\nmetro_data <- read_csv(\"x11_selecto_zonas_metro_martes.csv\" %>% \n      file.path(\"../data/cnbv/processed\", .)) %>%\n  mutate(CVEMET = CVEMET %>% str_pad(3, \"left\", \"0\"), \n      CVEENT = CVEENT %>% str_pad(2, \"left\", \"0\")) %>% \n  rename(atm_1 = atm_selecto) %>% \n  group_by(CVEENT, CVEMET) %>% arrange(trimestre) %>% \n  mutate(atm_1_crec = atm_1/lag(atm_1) - 1, \n      atm_crec_4 = lag(atm_1_crec, 4), \n      atm_1_anual = atm_1/lag(atm_1, 4) - 1) %>% ungroup %>% \n  filter(!is.na(atm_crec_4))\n\nmetro_fit <- augment(modelo_crec, newdata = metro_data) \nif (\"nombre_corto\" %in% names(metro_fit)) {\n  rename(metro_fit, zona_metro = nombre_corto) }\nmetro_fit <- metro_fit %>% \n  select(trimestre, CVEENT, CVEMET, zona_metro, crec_fit = .fitted)\n  \nwrite_csv(metro_fit, \n  \"../data/resultados/crecimiento/selecto_zona_metro_martes.csv\")\n\nwrite_csv(estado_fit, \n  \"../data/resultados/crecimiento/selecto_estado_martes.csv\")\n\n\n#### Generamos tasas de crecimiento anualizado acumulado. ####\n\nmetro_acumulado <- metro_fit %>%\n  mutate(a침o = year(trimestre), \n    uno_mas = 1 + crec_fit) %>% \n  group_by(CVEENT, CVEMET, zona_metro) %>% arrange(trimestre) %>% \n  mutate(\n    prod_4 = uno_mas*lag(uno_mas)*lag(uno_mas,2)*lag(uno_mas,3)) %>% \n  ungroup %>% \n  group_by(CVEENT, CVEMET, zona_metro, a침o) %>% \n  summarize(acum_anual = sum(prod_4)/4) \n  \nView(metro_acumulado)\n\n\n\n\n\n\n\n\n\n",
    "created" : 1539037713066.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2210839789",
    "id" : "6A3FB9F8",
    "lastKnownWriteTime" : 1539032711,
    "last_content_update" : 1539032711,
    "path" : "~/programming/pap/oto침o/indice-de-actividad-economica/imco_code/3_calcular_crecimientos_cnbv.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}